<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />

    <!-- Reference to the Bing Maps SDK -->
    <script type='text/javascript'
            src='http://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AkOvaEXpuYuvKD6xHCBpjmkGnubc1VxERFfQtQMD6fvaEJFcujrHF1C0oWXirPBU' 
            async defer></script>
    
    <script type='text/javascript'>
    let BingMapsKey = 'AkOvaEXpuYuvKD6xHCBpjmkGnubc1VxERFfQtQMD6fvaEJFcujrHF1C0oWXirPBU'
    let pins = []
    let shape = null
    let infobox = null
    let loadbox = null
    let placeName = null
    function GetMap()
    {
        let navigationBarMode = Microsoft.Maps.NavigationBarMode;
        let map = new Microsoft.Maps.Map('#myMap', {
            navigationBarMode: navigationBarMode.compact,
            mapTypeId: Microsoft.Maps.MapTypeId.aerial,
            zoom: 12
        });

        // Load modules
        Microsoft.Maps.loadModule('Microsoft.Maps.SpatialMath')
        Microsoft.Maps.loadModule('Microsoft.Maps.Search')

        addPushpinClickHandler(map)
        addMapClickHandler(map)
    }

    function addMapClickHandler(map) {
        // Add map right-click handler
        Microsoft.Maps.Events.addHandler(map, 'rightclick', function(e) {
            eraseBox(loadbox)
            eraseBox(infobox)
            
            loadbox = new Microsoft.Maps.Infobox(e.location, {
            description: 'Empty the map, save your waypoints, or load a saved file.',
            actions: [{
                    label: "Clear",
                    eventHandler: function(e) {
                        erasePins(map)
                        eraseShape(map)
                        eraseBox(loadbox)
                    }
                },
                {
                    label: "Save",
                    eventHandler: function(e) {
                        download(JSON.stringify(getPinnedLocations()), placeName + ".json", "text/plain")
                    }
                },
                {
                    label: "Load",
                    eventHandler: function(e) {
                        getJSONFileText().then(jsonData => {
                            eraseBox(loadbox)
                            erasePins(map)
                            eraseShape(map)
                            for(let i in jsonData) {
                                let location = { latitude: jsonData[i].latitude, longitude: jsonData[i].longitude }
                                addPushpin(map, location)
                                // Center map on first waypoint
                                if(i == 0)
                                    map.setView({ center: location, zoom: 15 });
                            }
                        })
                    }
                }]
            })
            // Set infobox title
            if(pins[0] != null)
                RESTlocationRecognition(pins[0].getLocation(), loadbox)
            loadbox.setMap(map)
        })
    }

    function addPushpinClickHandler(map) {
        // Add waypoint on map click
        Microsoft.Maps.Events.addHandler(map, 'click', function(e) {
            addPushpin(map, e.location)
        })
    }

    function addPushpin(map, location) {
        let pin = new Microsoft.Maps.Pushpin(location, {
            text: (pins.length + 1) + '',
            enableHoverStyle: true,
            draggable: true
        })

        // Add pushpin click handler
        Microsoft.Maps.Events.addHandler(pin, 'click', function(e) {
            eraseBox(loadbox)
            eraseBox(infobox)
            infobox = new Microsoft.Maps.Infobox(e.location, {
                title: 'Edit Waypoint',
                actions: [{
                    label: "Remove",
                    eventHandler: function(e) {
                        removePushpin(pin, map)
                        eraseBox(infobox)
                    }
                }]
            })
            infobox.setMap(map)
        })

        // Add drag handler
        Microsoft.Maps.Events.addHandler(pin, 'dragend', function(e) {
            drawLineThroughPins(map)
            eraseBox(infobox)
            eraseBox(loadbox)
        })

        map.entities.push(pin)
        pins.push(pin)
        drawLineThroughPins(map)
        eraseBox(loadbox)
        eraseBox(infobox)
    }

    function removePushpin(pin, map) {
        map.entities.remove(pin)
        removePin(pin)
        drawLineThroughPins(map)
    }

    // Erase previous lines and draw line through these pins
    function drawLineThroughPins(map) {
        if(pins.length > 1) {
            if(shape == null) {
                // Create the shape
                shape = new Microsoft.Maps.Polygon(getPinnedLocations(), null)
                map.entities.push(shape)
            }
            else {
                // Update the shape
                let spline = Microsoft.Maps.SpatialMath.getCardinalSpline(getPinnedLocations())
                shape.setLocations(spline)
            }
        }
        // We may need to erase a previous shape because a waypoint was removed
        else {
            if(shape != null) {
                map.entities.remove(shape)
                shape = null // Detect it has been removed later
            }
        }
    }

    function removePin(pin) {
        for(let i in pins) {
            if(pins[i].id == pin.id)
                pins.splice(i, 1)
        }

        // Re-number pins
        for(let i in pins) {
            pins[i].setOptions({ text: (Number(i) + 1) + '' })
        }
    }

    function erasePins(map) {
        for(let i in pins) {
           map.entities.remove(pins[i])
        }
        pins.splice(0, pins.length)
    }

    function eraseShape(map) {
        map.entities.remove(shape)
        shape = null
    }

    function eraseBox(box) {
        if(box == null)
            return
        else
            box.setMap(null)
    }

    function getPinnedLocations() {
        let locs = []
        for(i = 0; i < pins.length; i++)
            locs.push(pins[i].getLocation())
        return locs;
    }

    // "How do I save JSON to local text file"
    // https://stackoverflow.com/a/34156339/4682228
    function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], {type: contentType});
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
    }

    // Had to use this because other direct JavaScript API didn't have the place of interest functionality I wanted
    // (or at least, not good enough).
    // https://docs.microsoft.com/en-us/bingmaps/rest-services/locations/location-recognition
    async function RESTlocationRecognition(location, infobox) {
        // http://dev.virtualearth.net/REST/v1/locationrecog/47.640068,-122.129860?key={BingMapsAPIKey}&output=json

        let locationRecognition = "http://dev.virtualearth.net/REST/v1/locationrecog/" + location.latitude + "," + location.longitude + "?top=3&verboseplacenames=true&includeEntityTypes=businessAndPOI,address,naturalPOI&key=" + BingMapsKey + "&output=json"

        fetch(locationRecognition).then(response => response.json()).then(data => {
            let placeInfo = data.resourceSets[0].resources[0]
            placeName = findDescriptiveLocationName(placeInfo)
            infobox.setOptions({title: placeName})
        })
    }

    function findDescriptiveLocationName(placeInfo) {
        placeName = null

        // First check whether we have a non-plateau or ocean natural POI
        for(let i in placeInfo.naturalPOIAtLocation) {
            if(placeInfo.naturalPOIAtLocation[i].type != "Plateau" | "Sea" | "Valley" | "Reserve") {
                placeName = placeInfo.naturalPOIAtLocation[i].entityName
                return placeName
            }
        }

        // No geography found, let's try an address (these can often be empty)
        for(let i in placeInfo.addressOfLocation) {
            if(placeInfo.addressOfLocation[i].addressLine != "") {
                placeName = placeInfo.addressOfLocation[i].addressLine
                return placeName
            }
        }

        // No address found, let's try a business
        for(let i in placeInfo.businessesAtLocation) {
            if(placeInfo.businessesAtLocation[i].businessInfo.entityName != "") {
                placeName = placeInfo.businessesAtLocation[i].businessInfo.entityName
                return placeName
            }
        }

        // Still nothing? Backup geography! (This will likely give a lot of "Canadian Shield"-style answers)
        for(let i in placeInfo.naturalPOIAtLocation) {
            placeName = placeInfo.naturalPOIAtLocation[i].entityName
            return placeName
        }

        placeName = ""
        return placeName
    }

    function searchNearby(map, location) {
        let searchManager = new Microsoft.Maps.Search.SearchManager(map)
        let entityLookupRequestOptions = {
            location: location,
            callback: function (answer) {
                if (answer) {
                    console.log(answer)
                }
            }
        };
        searchManager.entityLookup(entityLookupRequestOptions);
    }

    function reverseGeocode(map, location) {
        let searchManager = new Microsoft.Maps.Search.SearchManager(map)
        let reverseGeocodeRequestOptions = {
            location: location,
            callback: function (answer, userData) {
                console.log(answer)
            }
        }
        searchManager.reverseGeocode(reverseGeocodeRequestOptions)
    }

    // Open a file and return its text contents
    async function getJSONFileText() {
        const pickerOpts = {
            types: [{
                description: 'JSON',
                accept: {
                    'JSON/*': ['.json']
                }
            }],
            excludeAcceptAllOption: true,
            multiple: false
        }
        let [fileHandle] = await window.showOpenFilePicker(pickerOpts)
        const file = await fileHandle.getFile()
        const text = await file.text()
        return JSON.parse(text)
    }

    function fileInputReceived() {
        let input = document.querySelector('input#file-picker')
        const files = input.files
        console.log(files)
    }
    </script>
</head>
<body style="margin: 0;">
    <div id="myMap" style="position:relative;width:100%;height:90%;"></div>

    <input type="file" id="file-picker" accept=".json" onchange="fileInputReceived()" />
</body>
</html>